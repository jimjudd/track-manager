<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sync E2E Tests</title>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        h2 { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Sync E2E Tests</h1>
    <p class="info">Note: These tests require Firebase authentication and internet connection</p>
    <p class="info">You must sign in manually when prompted</p>
    <button id="start-test-btn">Start E2E Test</button>
    <div id="test-results"></div>

    <script type="module">
        import { firebaseConfig } from '../../js/config/firebase-config.js';
        import { db } from '../../js/db.js';
        import { SyncService } from '../../js/services/sync.js';
        import { Program } from '../../js/models/Program.js';

        const results = document.getElementById('test-results');
        const startBtn = document.getElementById('start-test-btn');
        let passCount = 0;
        let failCount = 0;

        function logTest(name, passed, error = null) {
            const div = document.createElement('div');
            div.className = passed ? 'pass' : 'fail';
            div.textContent = `${passed ? '✓' : '✗'} ${name}`;
            if (error) {
                div.textContent += `: ${error.message}`;
            }
            results.appendChild(div);
            if (passed) passCount++;
            else failCount++;
        }

        startBtn.addEventListener('click', async () => {
            results.innerHTML = '<h2>Running E2E Tests...</h2>';
            startBtn.disabled = true;

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const firestore = firebase.firestore();

            // Wait for authentication
            results.innerHTML += '<p class="info">Please sign in when prompted...</p>';

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                logTest('User successfully authenticated', true);

                // Clear test data
                await db.programs.clear();
                results.innerHTML += '<p class="info">Cleared local database...</p>';

                // Initialize sync service
                const syncService = new SyncService(db, firestore, user.uid);
                await syncService.initialize();
                logTest('Sync service initialized', true);

                // Test: Create program in IndexedDB, verify it syncs to Firestore
                const programId = await db.programs.add(new Program('Test Program E2E', ['Warmup', 'Peak']));

                // Wait for sync
                await new Promise(resolve => setTimeout(resolve, 2000));

                const firestoreDoc = await firestore
                    .collection(`users/${user.uid}/programs`)
                    .doc(String(programId))
                    .get();

                if (firestoreDoc.exists && firestoreDoc.data().name === 'Test Program E2E') {
                    logTest('Program synced from IndexedDB to Firestore', true);
                } else {
                    throw new Error('Program not found in Firestore');
                }

                // Clean up
                await db.programs.delete(programId);
                await firestore
                    .collection(`users/${user.uid}/programs`)
                    .doc(String(programId))
                    .delete();

                syncService.destroy();
                await auth.signOut();

                // Summary
                results.innerHTML += `<h2>Summary: ${passCount} passed, ${failCount} failed</h2>`;
            } catch (error) {
                logTest('E2E test execution', false, error);
                results.innerHTML += `<h2>Summary: ${passCount} passed, ${failCount} failed</h2>`;
            }

            startBtn.disabled = false;
        });
    </script>
</body>
</html>
