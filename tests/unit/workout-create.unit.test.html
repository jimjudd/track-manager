<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Workout Create Unit Tests</title>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
</head>
<body>
    <h1>Workout Create Unit Tests</h1>
    <div id="results"></div>

    <script type="module">
        import { db } from '../../js/db.js';
        import { WorkoutsView } from '../../js/views/workouts.js';

        const results = document.getElementById('results');
        let testsPassed = 0;
        let testsFailed = 0;

        function logPass(message) {
            results.innerHTML += `<p style="color: green;">PASS: ${message}</p>`;
            testsPassed++;
        }

        function logFail(message) {
            results.innerHTML += `<p style="color: red;">FAIL: ${message}</p>`;
            testsFailed++;
        }

        async function setupTestData() {
            await db.programs.clear();
            await db.releases.clear();
            await db.tracks.clear();
            await db.workouts.clear();

            // Create a program
            const programId = await db.programs.add({
                name: 'BodyPump',
                trackTypes: ['Warmup', 'Squats', 'Chest']
            });

            // Create a release
            const releaseId = await db.releases.add({
                programId,
                releaseNumber: 125
            });

            // Create tracks
            await db.tracks.add({
                releaseId,
                trackType: 'Warmup',
                songTitle: 'Song 1',
                artist: 'Artist 1',
                rating: 4,
                lastUsed: null
            });

            await db.tracks.add({
                releaseId,
                trackType: 'Squats',
                songTitle: 'Song 2',
                artist: 'Artist 2',
                rating: 5,
                lastUsed: null
            });

            await db.tracks.add({
                releaseId,
                trackType: 'Chest',
                songTitle: 'Song 3',
                artist: 'Artist 3',
                rating: 3,
                lastUsed: null
            });

            return { programId, releaseId };
        }

        async function runTests() {
            await testNewWorkoutButtonOpensModal();
            await testProgramSelection();
            await testTrackSlots();

            results.innerHTML += `<hr><p><strong>Tests: ${testsPassed} passed, ${testsFailed} failed</strong></p>`;
        }

        async function testNewWorkoutButtonOpensModal() {
            try {
                await setupTestData();

                const container = document.createElement('div');
                const view = new WorkoutsView(container);
                await view.render();

                // Find and click new workout button
                const newBtn = container.querySelector('#new-workout-btn');
                if (!newBtn) {
                    throw new Error('New workout button not found');
                }

                // Simulate click
                newBtn.click();

                // Check if modal appears
                const modal = container.querySelector('#workout-editor-modal');
                if (!modal) {
                    throw new Error('Workout editor modal not found');
                }

                if (modal.classList.contains('hidden')) {
                    throw new Error('Modal should be visible after clicking new workout button');
                }

                logPass('New workout button opens modal');
            } catch (error) {
                logFail(`New workout button: ${error.message}`);
            }
        }

        async function testProgramSelection() {
            try {
                const container = document.createElement('div');
                const view = new WorkoutsView(container);
                await view.render();

                newBtn.click();

                // Check if program selector exists
                const programSelect = container.querySelector('#workout-program-select');
                if (!programSelect) {
                    throw new Error('Program selector not found in modal');
                }

                // Check if programs are loaded
                const options = programSelect.querySelectorAll('option');
                if (options.length < 2) { // At least placeholder + 1 program
                    throw new Error('Programs not loaded in selector');
                }

                logPass('Program selector works');
            } catch (error) {
                logFail(`Program selection: ${error.message}`);
            }
        }

        async function testTrackSlots() {
            try {
                const container = document.createElement('div');
                const view = new WorkoutsView(container);
                await view.render();

                // This test verifies that track slots appear after program selection
                // Implementation will create slots dynamically

                logPass('Track slots test placeholder');
            } catch (error) {
                logFail(`Track slots: ${error.message}`);
            }
        }

        runTests();
    </script>
</body>
</html>
