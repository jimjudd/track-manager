<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auth Integration Tests</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        h2 { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Auth Integration Tests</h1>
    <p class="info">Note: These tests require manual interaction (sign-in popup)</p>
    <div id="test-results"></div>
    <div id="test-container"></div>

    <script type="module">
        import { firebaseConfig } from '../../js/config/firebase-config.js';
        import { AuthView } from '../../js/views/auth.js';

        const results = document.getElementById('test-results');
        const testContainer = document.getElementById('test-container');
        let passCount = 0;
        let failCount = 0;

        function logTest(name, passed, error = null) {
            const div = document.createElement('div');
            div.className = passed ? 'pass' : 'fail';
            div.textContent = `${passed ? '✓' : '✗'} ${name}`;
            if (error) {
                div.textContent += `: ${error.message}`;
            }
            results.appendChild(div);
            if (passed) passCount++;
            else failCount++;
        }

        async function runTests() {
            results.innerHTML = '<h2>Running Integration Tests...</h2>';

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();

            // Test 1: Sign-in flow renders correctly
            try {
                const view = new AuthView(testContainer, auth);
                await view.render();

                const signInBtn = testContainer.querySelector('#sign-in-btn');
                if (signInBtn) {
                    logTest('Sign-in UI renders when not authenticated', true);
                } else {
                    throw new Error('Sign-in button not found');
                }
            } catch (error) {
                logTest('Sign-in UI renders when not authenticated', false, error);
            }

            // Test 2: Auth state listener works
            try {
                let callbackFired = false;
                const view = new AuthView(testContainer, auth);
                view.onAuthStateChanged((user) => {
                    callbackFired = true;
                });

                // Simulate user change
                view.setUser({ email: 'test@example.com' });

                if (callbackFired) {
                    logTest('Auth state change callback fires', true);
                } else {
                    throw new Error('Callback did not fire');
                }
            } catch (error) {
                logTest('Auth state change callback fires', false, error);
            }

            // Summary
            results.innerHTML += `<h2>Summary: ${passCount} passed, ${failCount} failed</h2>`;
        }

        runTests();
    </script>
</body>
</html>
